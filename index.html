<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marin AI - Your Visual Conversation Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .switch-checkbox:checked + .switch-label .switch-toggle {
            transform: translateX(1.5rem);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="bg-white shadow-2xl rounded-3xl p-6 md:p-10 w-full max-w-5xl text-gray-800">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-6 leading-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
            Marin AI Assistant
        </h1>
        <p class="text-center text-lg md:text-xl text-gray-600 mb-8 font-medium">
            Engage your life through video conversation.
        </p>

        <div class="flex flex-col lg:flex-row space-y-8 lg:space-y-0 lg:space-x-8">
            <div class="flex-1 flex flex-col items-center">
                <video id="webcam-video" autoplay playsinline class="rounded-2xl shadow-xl border-4 border-gray-300 w-full mb-6 max-h-96 object-cover bg-gray-200"></video>
                <div id="log-container" class="bg-gray-50 border border-gray-300 rounded-2xl p-4 h-48 w-full overflow-y-auto mb-4 hidden">
                    <p id="log" class="text-sm text-gray-600 leading-relaxed"></p>
                </div>
            </div>

            <div class="flex-1 space-y-6">
                <div id="controls-section" class="space-y-6">
                    <div>
                        <label for="voice-select" class="block text-sm font-semibold text-gray-700 mb-2">Select your favorite voice:</label>
                        <select id="voice-select" class="block w-full px-4 py-3 rounded-xl border-2 border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-colors duration-200 cursor-pointer">
                            <option value="puck">Puck</option>
                            <option value="kore">Kore</option>
                            <option value="fenrir">Fenrir</option>
                            <option value="charon">Charon</option>
                            <option value="aoede">Aoede</option>
                        </select>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label id="camera-switch-label" for="camera-switch" class="flex items-center cursor-pointer text-gray-700 font-semibold">Share your camera (Off)</label>
                            <div class="relative">
                                <input type="checkbox" id="camera-switch" role="switch" aria-checked="false" aria-label="Toggle camera" class="sr-only switch-checkbox">
                                <div class="block bg-gray-300 w-14 h-8 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition switch-toggle"></div>
                            </div>
                        </div>

                        <button id="switch-camera-button" class="w-full px-6 py-3 rounded-full bg-indigo-500 text-white font-semibold shadow transition-all duration-300 transform hover:scale-105 hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50" disabled>
                            Switch to Back Camera
                        </button>
                    </div>

                    <div class="flex items-center space-x-2 hidden" id="user-input-section">
                        <input type="text" id="prompt-input" placeholder="Type your prompt here..." class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <button id="send-button" class="px-6 py-3 rounded-full bg-blue-600 text-white font-bold shadow-md transition-all duration-300 transform hover:scale-105 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                            Send
                        </button>
                    </div>

                    <button id="mute-button" class="w-full px-6 py-3 rounded-full bg-yellow-500 text-white font-semibold shadow transition-all duration-300 transform hover:scale-105 hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-400 focus:ring-opacity-50 hidden" aria-label="Mute microphone">
                        Mute Microphone
                    </button>

                    <button id="start-call-button" class="w-full px-6 py-4 rounded-full text-white font-bold text-lg shadow-lg transition-all duration-300 transform hover:scale-105 bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                        Start Video Call
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { GoogleGenAI, Modality } from 'https://cdn.jsdelivr.net/npm/@google/generative-ai@0.1.0/dist/index.js';
        
        // -- Constants and Global State --
        // WARNING: Exposing your API key in client-side code is for prototyping only.
        // For production, use a secure backend or Firebase AI Logic to protect your API key.
        const API_KEY = "AIzaSyC2Fsjk3yCRA8hDVYgg5LlMn4sxwoJJaWU";
        
        let isCallActive = false;
        let isMuted = false;
        let isCameraOn = false;
        let isFrontCamera = true;
        let session = null;
        let mediaStream = null;
        let audioContext = null;
        let audioSource = null;
        let scriptProcessorNode = null;
        let videoCanvas = null;
        let videoContext = null;
        let videoInterval = null;

        // -- DOM Element References --
        const startCallButton = document.getElementById('start-call-button');
        const voiceSelect = document.getElementById('voice-select');
        const cameraSwitch = document.getElementById('camera-switch');
        const cameraSwitchLabel = document.getElementById('camera-switch-label');
        const switchCameraButton = document.getElementById('switch-camera-button');
        const muteButton = document.getElementById('mute-button');
        const userInputSection = document.getElementById('user-input-section');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const videoElement = document.getElementById('webcam-video');
        const logContainer = document.getElementById('log-container');
        const logElement = document.getElementById('log');

        // -- Utility Functions --
        function showToast(message, color) {
            Toastify({
                text: message,
                duration: 3000,
                close: false,
                gravity: "bottom",
                position: "center",
                backgroundColor: color,
                stopOnFocus: true
            }).showToast();
        }

        // Plays PCM audio using the Web Audio API.
        let audioQueue = [];
        let isPlaying = false;
        async function playPcmAudio(audioBuffer, sampleRate = 16000) {
            audioQueue.push({ buffer: audioBuffer, sampleRate: sampleRate });
            if (!isPlaying) {
                processAudioQueue();
            }
        }

        async function processAudioQueue() {
            if (audioQueue.length === 0 || isPlaying) {
                return;
            }

            isPlaying = true;
            const { buffer, sampleRate } = audioQueue.shift();
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: sampleRate });

            try {
                const audioData = await audioCtx.decodeAudioData(buffer);
                const source = audioCtx.createBufferSource();
                source.buffer = audioData;
                source.connect(audioCtx.destination);
                source.onended = () => {
                    audioCtx.close();
                    isPlaying = false;
                    processAudioQueue();
                };
                source.start(0);
            } catch (e) {
                console.error("Error decoding audio data:", e);
                isPlaying = false;
                processAudioQueue();
            }
        }

        // Converts Base64 string to an ArrayBuffer.
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function initVideoCanvas() {
            if (!videoCanvas) {
                videoCanvas = document.createElement('canvas');
                videoContext = videoCanvas.getContext('2d');
            }
        }

        function startSendingVideo() {
            if (!isCameraOn || !session || videoInterval) {
                return;
            }
            initVideoCanvas();
            videoInterval = setInterval(() => {
                videoCanvas.width = videoElement.videoWidth;
                videoCanvas.height = videoElement.videoHeight;
                videoContext.drawImage(videoElement, 0, 0, videoCanvas.width, videoCanvas.height);
                const imageDataURL = videoCanvas.toDataURL('image/jpeg');
                const base64Data = imageDataURL.split(',')[1];
                
                if (session && session.readyState === WebSocket.OPEN) {
                    session.sendClientContent({
                        parts: [{
                            inlineData: {
                                mimeType: "image/jpeg",
                                data: base64Data
                            }
                        }]
                    });
                }
            }, 1000 / 5); // Send 5 frames per second
        }

        function stopSendingVideo() {
            if (videoInterval) {
                clearInterval(videoInterval);
                videoInterval = null;
            }
        }

        function initAudioRecording() {
            if (!mediaStream) {
                console.error("No media stream available for recording.");
                return;
            }

            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            audioSource = audioContext.createMediaStreamSource(mediaStream);
            scriptProcessorNode = audioContext.createScriptProcessor(4096, 1, 1);
            
            scriptProcessorNode.onaudioprocess = (e) => {
                if (isCallActive && !isMuted && session) {
                    const inputBuffer = e.inputBuffer.getChannelData(0);
                    const pcm16 = new Int16Array(inputBuffer.length);
                    for (let i = 0; i < inputBuffer.length; i++) {
                        pcm16[i] = Math.max(-1, Math.min(1, inputBuffer[i])) * 0x7FFF;
                    }

                    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(pcm16.buffer)));
                    session.sendClientContent({
                        parts: [{
                            inlineData: {
                                mimeType: "audio/x-raw;rate=16000",
                                data: base64Audio
                            }
                        }]
                    });
                }
            };
            
            audioSource.connect(scriptProcessorNode);
            scriptProcessorNode.connect(audioContext.destination);
        }

        function stopAudioRecording() {
            if (scriptProcessorNode) {
                scriptProcessorNode.disconnect();
                scriptProcessorNode = null;
            }
            if (audioSource) {
                audioSource.disconnect();
                audioSource = null;
            }
            if (audioContext) {
                audioContext.close().catch(e => console.error("Error closing audio context:", e));
                audioContext = null;
            }
        }
        
        // -- Main Application Logic --
        function updateUI() {
            startCallButton.textContent = isCallActive ? 'End Call' : 'Start Video Call';
            startCallButton.classList.toggle('bg-green-600', !isCallActive);
            startCallButton.classList.toggle('hover:bg-green-700', !isCallActive);
            startCallButton.classList.toggle('bg-red-600', isCallActive);
            startCallButton.classList.toggle('hover:bg-red-700', isCallActive);
            
            cameraSwitchLabel.textContent = `Share your camera (${isCameraOn ? 'On' : 'Off'})`;
            cameraSwitch.checked = isCameraOn;
            cameraSwitch.setAttribute('aria-checked', isCameraOn);
            
            switchCameraButton.textContent = isFrontCamera ? 'Switch to Back Camera' : 'Switch to Front Camera';
            switchCameraButton.disabled = !isCameraOn;

            muteButton.classList.toggle('hidden', !isCallActive);
            userInputSection.classList.toggle('hidden', !isCallActive);
            logContainer.classList.toggle('hidden', !isCallActive);

            if (isCameraOn && mediaStream) {
                videoElement.srcObject = mediaStream;
                videoElement.classList.add('border-blue-500');
                videoElement.classList.remove('border-gray-300');
            } else {
                videoElement.srcObject = null;
                videoElement.classList.add('border-gray-300');
                videoElement.classList.remove('border-blue-500');
            }
        }

        async function requestPermissions(constraints) {
            try {
                return await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                showToast(`Error accessing media devices: ${err.message}`, 'bg-red-500');
                return null;
            }
        }

        async function toggleCall() {
            if (isCallActive) {
                // End the call
                if (session) {
                    await session.close();
                    session = null;
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                stopAudioRecording();
                stopSendingVideo();
                isCallActive = false;
                isCameraOn = false;
                isMuted = false;
                showToast('Video call ended.', 'bg-red-500');
                updateUI();
                logElement.textContent = '';
            } else {
                // Start the call
                startCallButton.disabled = true;
                startCallButton.textContent = 'Connecting...';
                showToast('Connecting to Marin AI...', 'bg-blue-500');
                
                const constraints = {
                    audio: true,
                    video: isCameraOn ? { facingMode: isFrontCamera ? 'user' : 'environment' } : false
                };
                
                const stream = await requestPermissions(constraints);
                if (!stream) {
                    startCallButton.disabled = false;
                    startCallButton.textContent = 'Start Video Call';
                    return;
                }
                
                mediaStream = stream;
                initAudioRecording();
                
                try {
                    const ai = new GoogleGenAI({ apiKey: API_KEY });
                    session = await ai.live.connect({
                        model: 'gemini-2.5-flash-preview',
                        config: {
                            responseModalities: [Modality.TEXT, Modality.AUDIO],
                            speechConfig: {
                                voice: voiceSelect.value
                            }
                        }
                    });
                    
                    isCallActive = true;
                    startCallButton.disabled = false;
                    showToast('Connected to Marin AI! Welcome.', 'bg-green-500');
                    updateUI();
                    
                    // Start receiving responses
                    (async () => {
                        for await (const message of session.receive()) {
                            if (message.serverContent?.turns) {
                                for (const turn of message.serverContent.turns) {
                                    if (turn.parts) {
                                        for (const part of turn.parts) {
                                            if (part.text) {
                                                logElement.textContent += `\nAI: ${part.text}`;
                                                logContainer.scrollTop = logContainer.scrollHeight;
                                            }
                                            if (part.inlineData?.mimeType.startsWith('audio/')) {
                                                const audioBase64 = part.inlineData.data;
                                                const audioBuffer = base64ToArrayBuffer(audioBase64);
                                                const sampleRateMatch = part.inlineData.mimeType.match(/rate=(\d+)/);
                                                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                                                playPcmAudio(audioBuffer, sampleRate);
                                            }
                                        }
                                    }
                                }
                        }
                    })();

                    // Send initial system instructions
                    const initialConfig = {
                        parts: [{
                            text: "Hi, you are Marin AI assistant - developed by Sujan Rai at Team of Tech Visionary. You are currently in beta preview. Your capabilities: you can see what's around the users and help in any tasks. You are a helpful assistant. Introduce yourself and ask the user how you can help them. Suggest turning the camera on for visual guidance. Engage in a professional and friendly tone."
                        }]
                    };
                    await session.sendClientContent(initialConfig);
                    
                    // Start sending video if camera is on
                    if (isCameraOn) {
                        startSendingVideo();
                    }
                } catch (e) {
                    console.error("SDK connection error:", e);
                    showToast(`Error connecting to AI: ${e.message}`, 'bg-red-500');
                    startCallButton.disabled = false;
                    startCallButton.textContent = 'Start Video Call';
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                        mediaStream = null;
                    }
                    stopAudioRecording();
                }
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (mediaStream) {
                mediaStream.getAudioTracks().forEach(track => {
                    track.enabled = !isMuted;
                });
            }
            muteButton.textContent = isMuted ? 'Unmute Microphone' : 'Mute Microphone';
            muteButton.classList.toggle('bg-gray-500', isMuted);
            muteButton.classList.toggle('bg-yellow-500', !isMuted);
            showToast(isMuted ? 'Microphone muted.' : 'Microphone unmuted.', isMuted ? 'bg-gray-500' : 'bg-yellow-500');
        }

        async function toggleCamera() {
            isCameraOn = cameraSwitch.checked;
            if (isCameraOn) {
                const constraints = {
                    video: { facingMode: isFrontCamera ? 'user' : 'environment' }
                };
                const videoStream = await requestPermissions(constraints);
                if (videoStream) {
                    if (mediaStream) {
                        const oldVideoTrack = mediaStream.getVideoTracks()[0];
                        if (oldVideoTrack) {
                            mediaStream.removeTrack(oldVideoTrack);
                        }
                        mediaStream.addTrack(videoStream.getVideoTracks()[0]);
                    } else {
                        mediaStream = videoStream;
                    }
                    showToast('Camera is now ON.', 'bg-green-500');
                    if (isCallActive) {
                        startSendingVideo();
                    }
                } else {
                    cameraSwitch.checked = false;
                    isCameraOn = false;
                    showToast('Failed to turn on camera.', 'bg-red-500');
                }
            } else {
                if (mediaStream) {
                    const videoTrack = mediaStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.stop();
                        mediaStream.removeTrack(videoTrack);
                    }
                }
                showToast('Camera is now OFF.', 'bg-gray-500');
                stopSendingVideo();
            }
            updateUI();
        }

        async function switchCamera() {
            if (!isCameraOn) return;
            isFrontCamera = !isFrontCamera;

            const constraints = {
                video: { facingMode: isFrontCamera ? 'user' : 'environment' }
            };
            try {
                const videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                const newVideoTrack = videoStream.getVideoTracks()[0];
                const oldVideoTrack = mediaStream.getVideoTracks()[0];
                
                if (oldVideoTrack) {
                    oldVideoTrack.stop();
                    mediaStream.removeTrack(oldVideoTrack);
                }
                mediaStream.addTrack(newVideoTrack);
                showToast(`Switched to ${isFrontCamera ? 'Front' : 'Back'} Camera.`, 'bg-blue-500');
            } catch (err) {
                console.error('Error switching camera:', err);
                showToast('Failed to switch camera.', 'bg-red-500');
                isFrontCamera = !isFrontCamera; // Revert on failure
            }
            updateUI();
        }

        function sendPrompt() {
            const promptText = promptInput.value.trim();
            if (promptText && isCallActive && session) {
                session.sendClientContent({
                    parts: [{ text: promptText }]
                });
                logElement.textContent += `\nUser: ${promptText}`;
                logContainer.scrollTop = logContainer.scrollHeight;
                promptInput.value = '';
            } else if (!isCallActive) {
                showToast("Please start a call first.", 'bg-red-500');
            } else {
                showToast("Live session is not ready.", 'bg-red-500');
            }
        }

        // -- Event Listeners and Initialization --
        function initApp() {
            // Attach event listener for start call button
            startCallButton.addEventListener('click', async (event) => {
                event.preventDefault();
                await toggleCall();
            });

            muteButton.addEventListener('click', toggleMute);
            sendButton.addEventListener('click', sendPrompt);
            promptInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendPrompt();
            });
            cameraSwitch.addEventListener('change', toggleCamera);
            switchCameraButton.addEventListener('click', switchCamera);
            
            updateUI();
        }

        // Initialize app when DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
